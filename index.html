<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="theme-color" content="#000000" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Udayana Portal" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="msapplication-TileColor" content="#000000" />
<meta name="msapplication-tap-highlight" content="no" />
<title>Udayana Portal</title>

<!-- PWA Icons -->
<link rel="apple-touch-icon" sizes="180x180" href="https://babinsa05.github.io/tombol2/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://babinsa05.github.io/tombol2/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://babinsa05.github.io/tombol2/favicon-16x16.png">
<link rel="manifest" href="https://babinsa05.github.io/tombol2/site.webmanifest">

<!-- Fallback icons -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<style>
  /* ===== CRITICAL CSS (Load First) ===== */
  * { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent;
  }

  html, body {
    height: 100%;
    overflow-x: hidden;
    background: #0a1525;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  }

  /* ===== APP SHELL (Visible Immediately) ===== */
  .app-shell {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #0a1525 0%, #071121 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    transition: opacity 0.5s ease;
  }

  .app-shell.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .app-logo {
    width: 120px;
    height: 120px;
    margin-bottom: 20px;
    animation: pulse 2s infinite;
  }

  .app-title {
    color: #ffd700;
    font-size: 24px;
    font-weight: bold;
    text-align: center;
    margin-bottom: 10px;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
  }

  .app-loading {
    width: 200px;
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 20px;
  }

  .app-progress {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, #ffd700, #ff8c00);
    border-radius: 2px;
    transition: width 0.3s ease;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  /* ===== MAIN CONTENT (Loaded After) ===== */
  .main-content {
    width: 100%;
    min-height: 100vh;
    padding: 20px;
    display: none;
  }

  .main-content.loaded {
    display: block;
  }

  /* ===== HEADER ===== */
  .udayana-header {
    text-align: center;
    padding: 20px 0;
    margin-bottom: 30px;
  }

  .udayana-logo {
    width: 100px;
    height: 100px;
    filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.5));
    margin-bottom: 15px;
  }

  .udayana-title {
    color: #ffd700;
    font-size: 24px;
    font-weight: bold;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
  }

  /* ===== BUTTONS GRID ===== */
  .buttons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
  }

  @media (max-width: 480px) {
    .buttons-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .portal-button {
    background: rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 215, 0, 0.2);
    border-radius: 15px;
    padding: 20px 10px;
    color: white;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 140px;
    backdrop-filter: blur(10px);
  }

  .portal-button:hover {
    transform: translateY(-5px);
    border-color: rgba(255, 215, 0, 0.5);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
  }

  .button-icon {
    font-size: 40px;
    margin-bottom: 10px;
  }

  .button-text {
    text-align: center;
    line-height: 1.3;
  }

  /* ===== INSTALL BUTTONS ===== */
  .install-fixed {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 1000;
  }

  .install-btn {
    background: linear-gradient(135deg, #ffd700, #ff8c00);
    color: black;
    border: none;
    border-radius: 25px;
    padding: 12px 20px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    min-width: 160px;
  }

  .install-btn:hover {
    transform: scale(1.05);
  }

  .install-btn.apk {
    background: linear-gradient(135deg, #4CAF50, #2E7D32);
    color: white;
  }

  /* ===== TOAST NOTIFICATION ===== */
  .toast-container {
    position: fixed;
    bottom: 100px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    z-index: 1001;
    pointer-events: none;
  }

  .toast {
    background: rgba(0, 0, 0, 0.8);
    color: #ffd700;
    padding: 12px 24px;
    border-radius: 25px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 215, 0, 0.3);
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
  }

  .toast.show {
    opacity: 1;
    transform: translateY(0);
  }

  /* ===== ERROR BOUNDARY ===== */
  .error-boundary {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #0a1525;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    text-align: center;
    z-index: 10000;
  }

  .error-boundary.active {
    display: flex;
  }

  .error-icon {
    font-size: 60px;
    color: #ff6b6b;
    margin-bottom: 20px;
  }

  .error-message {
    color: white;
    margin-bottom: 20px;
    max-width: 400px;
  }

  .retry-btn {
    background: #ffd700;
    color: black;
    border: none;
    border-radius: 10px;
    padding: 10px 20px;
    font-weight: bold;
    cursor: pointer;
  }
</style>
</head>

<body>
<!-- ===== APP SHELL (Critical First Paint) ===== -->
<div class="app-shell" id="appShell">
  <img src="https://upload.wikimedia.org/wikipedia/commons/2/25/Lambang_Kodam_Udayana.svg" 
       alt="Udayana" class="app-logo">
  <div class="app-title">UDAYANA PORTAL</div>
  <div class="app-loading">
    <div class="app-progress" id="appProgress"></div>
  </div>
</div>

<!-- ===== ERROR BOUNDARY ===== -->
<div class="error-boundary" id="errorBoundary">
  <div class="error-icon">‚ö†Ô∏è</div>
  <div class="error-message" id="errorMessage">
    Terjadi kesalahan saat memuat aplikasi.
  </div>
  <button class="retry-btn" onclick="window.location.reload()">Coba Lagi</button>
</div>

<!-- ===== MAIN CONTENT ===== -->
<div class="main-content" id="mainContent">
  <!-- Header -->
  <header class="udayana-header">
    <img src="https://upload.wikimedia.org/wikipedia/commons/2/25/Lambang_Kodam_Udayana.svg" 
         alt="Udayana" class="udayana-logo">
    <h1 class="udayana-title">UDAYANA PORTAL</h1>
  </header>

  <!-- Buttons Grid -->
  <main class="buttons-grid">
    <!-- 6 Tombol Utama -->
    <button class="portal-button" id="btn1">
      <div class="button-icon">üõ°Ô∏è</div>
      <div class="button-text">DUKOPS</div>
    </button>
    
    <button class="portal-button" id="btn2">
      <div class="button-icon">üéñÔ∏è</div>
      <div class="button-text">LPST05</div>
    </button>
    
    <button class="portal-button" id="btn3">
      <div class="button-icon">üìÅ</div>
      <div class="button-text">GOOGLE DRIVE</div>
    </button>
    
    <button class="portal-button" id="btn4">
      <div class="button-icon">üó∫Ô∏è</div>
      <div class="button-text">PEMETAAN LAHAN</div>
    </button>
    
    <button class="portal-button" id="btn5">
      <div class="button-icon">üåê</div>
      <div class="button-text">PORTAL KDKMP</div>
    </button>
    
    <button class="portal-button" id="btn6">
      <div class="button-icon">‚öôÔ∏è</div>
      <div class="button-text">LAINNYA</div>
    </button>
  </main>
</div>

<!-- ===== INSTALL BUTTONS ===== -->
<div class="install-fixed">
  <button class="install-btn apk" id="apkButton">
  </button>
  <button class="install-btn" id="pwaButton" style="display: none;">
    üì≤ Install PWA
  </button>
</div>

<!-- ===== TOAST CONTAINER ===== -->
<div class="toast-container">
  <div class="toast" id="toast"></div>
</div>

<!-- ===== MAIN SCRIPT ===== -->
<script>
// ===== UDAYANA PORTAL - GITHUB PAGES OPTIMIZED =====
// PWA + APK Installation

// Global Error Handler
window.addEventListener('error', (e) => {
  console.error('Global Error:', e.error);
  showError('Terjadi kesalahan: ' + (e.message || 'Unknown error'));
  return true;
});

window.addEventListener('unhandledrejection', (e) => {
  console.error('Unhandled Promise:', e.reason);
  showError('Promise rejected: ' + (e.reason || 'Unknown'));
});

// ===== ERROR HANDLING =====
function showError(message) {
  const errorBoundary = document.getElementById('errorBoundary');
  const errorMessage = document.getElementById('errorMessage');
  
  errorMessage.textContent = message;
  errorBoundary.classList.add('active');
  document.getElementById('appShell').classList.add('hidden');
  document.getElementById('mainContent').classList.remove('loaded');
}

function hideError() {
  document.getElementById('errorBoundary').classList.remove('active');
}

// ===== TOAST SYSTEM =====
function showToast(message, duration = 3000) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, duration);
}

// ===== APP PROGRESS =====
function updateProgress(percent) {
  const progress = document.getElementById('appProgress');
  if (progress) {
    progress.style.width = `${Math.min(percent, 100)}%`;
  }
}

// ===== BUTTON CONFIGURATION =====
const BUTTON_CONFIG = {
  btn1: { 
    url: "https://koramil05.github.io/DUKOPS/", 
    name: "DUKOPS",
    fallback: "https://koramil05.github.io/DUKOPS/"
  },
  btn2: { 
    url: "https://koramil05.github.io/LPST05/", 
    name: "LPST05",
    fallback: "https://koramil05.github.io/LPST05/"
  },
  btn3: { 
    url: "https://drive.google.com/drive/folders/1K9iWrM9fGU3sMcEZCmUWIbx0rLs285_x", 
    name: "GOOGLE DRIVE",
    fallback: "https://drive.google.com"
  },
  btn4: { 
    url: "https://pemetaan-lahan.portalkdkmp.id",
    name: "PEMETAAN LAHAN",
    fallback: "https://pemetaan-lahan.portalkdkmp.id"
  },
  btn5: { 
    url: "https://portalkdkmp.id/",
    name: "PORTAL KDKMP",
    fallback: "https://portalkdkmp.id"
  },
  btn6: { 
    url: "#",
    name: "LAINNYA",
    action: () => showToast("Tombol ini bisa dikustomisasi untuk fitur tambahan", 3000)
  }
};

// ===== BUTTON HANDLERS =====
function setupButtons() {
  try {
    Object.keys(BUTTON_CONFIG).forEach(btnId => {
      const button = document.getElementById(btnId);
      const config = BUTTON_CONFIG[btnId];
      
      if (!button) {
        console.warn(`Button ${btnId} not found`);
        return;
      }
      
      button.addEventListener('click', async () => {
        button.style.transform = 'scale(0.95)';
        
        if (btnId === 'btn6' && config.action) {
          setTimeout(() => {
            button.style.transform = '';
            config.action();
          }, 200);
          return;
        }
        
        showToast(`Membuka ${config.name}...`);
        
        setTimeout(() => {
          try {
            const newWindow = window.open(config.url, '_blank');
            
            setTimeout(() => {
              if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                window.open(config.fallback, '_blank');
              }
            }, 500);
          } catch (error) {
            window.open(config.fallback, '_blank');
          }
          
          setTimeout(() => {
            button.style.transform = '';
          }, 1000);
        }, 300);
      });
    });
    
    console.log('Buttons setup successfully');
  } catch (error) {
    console.error('Error setting up buttons:', error);
    showError('Gagal setup tombol: ' + error.message);
  }
}

// ===== APK INSTALLATION =====
document.getElementById('apkButton').addEventListener('click', () => {
  // Ganti dengan URL APK yang valid
  const apkUrl = 'https://example.com/udayana-portal.apk'; // Ganti dengan URL APK Anda
  
  showToast('Mengunduh APK...', 2000);
  
  // Open APK download
  window.open(apkUrl, '_blank');
  
  // Show installation guide
  setTimeout(() => {
    const isAndroid = /Android/.test(navigator.userAgent);
    let message = 'üì± Untuk menginstal APK:\n';
    
    if (isAndroid) {
      message += '1. Buka File Manager\n';
      message += '2. Temukan file APK yang diunduh\n';
      message += '3. Ketuk untuk menginstal\n';
      message += '4. Izinkan instalasi dari sumber tidak dikenal\n';
    } else {
      message += 'APK hanya bisa diinstal di perangkat Android';
    }
    
    alert('Panduan Instalasi APK:\n\n' + message);
  }, 1000);
});

// ===== PWA INSTALLATION SYSTEM =====
let deferredPrompt = null;
const pwaButton = document.getElementById('pwaButton');

window.addEventListener('beforeinstallprompt', (e) => {
  console.log('üì± PWA Install Prompt Available');
  e.preventDefault();
  deferredPrompt = e;
  
  setTimeout(() => {
    if (deferredPrompt && pwaButton) {
      pwaButton.style.display = 'flex';
      
      pwaButton.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        
        try {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          
          if (outcome === 'accepted') {
            console.log('‚úÖ User accepted PWA install');
            showToast('Aplikasi sedang diinstal...', 2000);
            pwaButton.style.display = 'none';
            
            localStorage.setItem('pwa_installed', 'true');
            localStorage.setItem('pwa_install_date', new Date().toISOString());
          } else {
            console.log('‚ùå User dismissed PWA install');
            showToast('Instalasi dibatalkan', 2000);
          }
        } catch (error) {
          console.error('Install error:', error);
          showToast('Gagal menginstal: ' + error.message, 3000);
        }
        
        deferredPrompt = null;
      });
    }
  }, 3000);
});

window.addEventListener('appinstalled', (e) => {
  console.log('üéâ PWA Installed Successfully');
  
  if (pwaButton) {
    pwaButton.style.display = 'none';
  }
  
  setTimeout(() => {
    showToast('Aplikasi berhasil diinstal! üéâ', 3000);
  }, 1000);
});

// ===== SERVICE WORKER REGISTRATION =====
async function registerServiceWorker() {
  if (!('serviceWorker' in navigator)) {
    console.warn('Service Worker not supported');
    return null;
  }
  
  try {
    // Register Service Worker dari file sw.js
    const registration = await navigator.serviceWorker.register('sw.js', {
      scope: './',
      updateViaCache: 'none'
    });
    
    console.log('‚úÖ Service Worker registered:', registration.scope);
    
    registration.addEventListener('updatefound', () => {
      const newWorker = registration.installing;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          showToast('Update tersedia! Segarkan halaman.', 5000);
        }
      });
    });
    
    return registration;
    
  } catch (error) {
    console.error('‚ùå Service Worker registration failed:', error);
    showToast('Mode offline tidak tersedia', 3000);
    return null;
  }
}

// ===== CREATE MANIFEST =====
function createManifest() {
  const manifest = {
    "name": "Udayana Portal",
    "short_name": "Udayana",
    "description": "Portal Akses Cepat Kodam Udayana",
    "start_url": "https://babinsa05.github.io/tombol2/",
    "display": "standalone",
    "background_color": "#0a1525",
    "theme_color": "#000000",
    "icons": [
      {
        "src": "https://babinsa05.github.io/tombol2/favicon-32x32.png",
        "sizes": "32x32",
        "type": "image/png"
      },
      {
        "src": "https://babinsa05.github.io/tombol2/apple-touch-icon.png",
        "sizes": "180x180",
        "type": "image/png"
      }
    ]
  };
  
  const manifestElement = document.createElement('link');
  manifestElement.rel = 'manifest';
  manifestElement.href = 'data:application/manifest+json,' + encodeURIComponent(JSON.stringify(manifest));
  
  const existingManifest = document.querySelector('link[rel="manifest"]');
  if (existingManifest) {
    existingManifest.remove();
  }
  
  document.head.appendChild(manifestElement);
  console.log('‚úÖ Dynamic Manifest created');
}

// ===== INITIALIZE APP =====
async function initializeApp() {
  try {
    console.log('üöÄ Initializing Koramil Sukasada Portal...');
    
    updateProgress(10);
    createManifest();
    updateProgress(30);
    
    await registerServiceWorker();
    updateProgress(60);
    
    setupButtons();
    updateProgress(80);
    
    // Check PWA mode
    if (window.matchMedia('(display-mode: standalone)').matches) {
      console.log('üì± Running as installed PWA');
      showToast('Mode aplikasi aktif', 2000);
      localStorage.setItem('pwa_mode', 'standalone');
      
      // Hide install buttons in PWA mode
      document.querySelector('.install-fixed').style.display = 'none';
    }
    
    updateProgress(100);
    
    setTimeout(() => {
      document.getElementById('appShell').classList.add('hidden');
      document.getElementById('mainContent').classList.add('loaded');
      hideError();
      
      showToast('Udayana Portal siap digunakan! üéØ', 2000);
      
      if (!localStorage.getItem('first_visit')) {
        localStorage.setItem('first_visit', new Date().toISOString());
        console.log('üëã First visit tracked');
      }
      
    }, 500);
    
    console.log('‚úÖ Koramil Sukasada Portal initialized successfully');
    
  } catch (error) {
    console.error('‚ùå Initialization failed:', error);
    showError('Gagal memuat aplikasi: ' + error.message);
  }
}

// ===== START APP =====
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(initializeApp, 100);
});

// ===== NETWORK STATUS =====
window.addEventListener('online', () => {
  showToast('Koneksi internet tersedia', 2000);
  console.log('üåê Online');
});

window.addEventListener('offline', () => {
  showToast('Mode offline aktif', 3000);
  console.log('üì¥ Offline');
});

// ===== UPDATE CHECK =====
setInterval(() => {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then(reg => {
      if (reg) reg.update();
    });
  }
}, 3600000);

// ===== INSTALL GUIDE =====
function showInstallGuide() {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  const isAndroid = /Android/.test(navigator.userAgent);
  
  let message = '';
  
  if (isIOS) {
    message = 'üì± Untuk iOS:\n1. Buka di Safari\n2. Tekan tombol Share\n3. Pilih "Add to Home Screen"';
  } else if (isAndroid) {
    message = 'üì± Untuk Android:\n1. Buka di Chrome\n2. Menu ‚Üí "Add to Home Screen"\n3. Tekan "Add"';
  } else {
    message = 'üíª Untuk Desktop:\n1. Klik tombol "Install PWA"\n2. Konfirmasi instalasi';
  }
  
  alert('üîÑ Cara Install Aplikasi:\n\n' + message);
}

// Add install guide button
if (!window.matchMedia('(display-mode: standalone)').matches) {
  setTimeout(() => {
    const guideBtn = document.createElement('button');
    guideBtn.innerHTML = '‚ùì Cara Install';
    guideBtn.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 10px 15px;
      background: rgba(255, 215, 0, 0.2);
      border: 2px solid rgba(255, 215, 0, 0.5);
      color: #ffd700;
      border-radius: 20px;
      cursor: pointer;
      z-index: 1000;
      backdrop-filter: blur(10px);
    `;
    guideBtn.onclick = showInstallGuide;
    document.body.appendChild(guideBtn);
  }, 5000);
}
</script>
</body>
</html>
